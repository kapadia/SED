require('lib/setup')

Spine = require('spine')

class Sed extends Spine.Controller
  elements:
    '#submit'     : 'submitButton'
    '#ra-input'   : 'ra'
    '#dec-input'  : 'dec'
    '#plots'      : 'plots'

  events:
    'click #submit' : 'submit'

  constructor: ->
    super
    @ra.val(18.39509)
    @dec.val(-13.25730)

  submit: (e) ->
    e.preventDefault()
    url = @generateURL @ra.val(), @dec.val()
    @retrieveFromMWP url

  generateURL: (ra, dec) ->
    query = encodeURIComponent(
      "SELECT basic.OID, RA, DEC, main_id, coo_bibcode, filter, flux FROM basic JOIN flux ON oidref = oid WHERE CONTAINS(POINT('ICRS', RA, DEC), CIRCLE('ICRS', #{ra}, #{dec}, 0.5)) = 1 ORDER BY main_id"
    )
    url = "http://simbad.u-strasbg.fr/simbad/sim-tap/sync?request=doQuery&lang=ADQL&format=JSON&query=#{query}"

  retrieveFromMWP: (source) ->
    console.log 'retrieveFromMWP'
    # Faking some data until the MWP public API works
    data = {"data":[[1306612,18.681250000000002,-13.446805555555557,"1RXS J011443.6-132649","2003yCat.2246....0C","R",14.5],[1306612,18.681250000000002,-13.446805555555557,"1RXS J011443.6-132649","2003yCat.2246....0C","B",15.5],[1306612,18.681250000000002,-13.446805555555557,"1RXS J011443.6-132649","2003yCat.2246....0C","K",13.777],[1306612,18.681250000000002,-13.446805555555557,"1RXS J011443.6-132649","2003yCat.2246....0C","H",13.815],[1306612,18.681250000000002,-13.446805555555557,"1RXS J011443.6-132649","2003yCat.2246....0C","J",14.094],[1316566,18.49188333333334,-13.18038611111111,"2MASX J01135805-1310493","2006AJ....131.1163S","R",15.4],[1316566,18.49188333333334,-13.18038611111111,"2MASX J01135805-1310493","2006AJ....131.1163S","V",15.6],[1316566,18.49188333333334,-13.18038611111111,"2MASX J01135805-1310493","2006AJ....131.1163S","K",13.787],[1316566,18.49188333333334,-13.18038611111111,"2MASX J01135805-1310493","2006AJ....131.1163S","H",14.29],[1316566,18.49188333333334,-13.18038611111111,"2MASX J01135805-1310493","2006AJ....131.1163S","J",14.952],[1316566,18.49188333333334,-13.18038611111111,"2MASX J01135805-1310493","2006AJ....131.1163S","B",15.7],[4059512,18.67467083333333,-13.421286111111112,"2MFGC 933","2006AJ....131.1163S","H",13.217],[4059512,18.67467083333333,-13.421286111111112,"2MFGC 933","2006AJ....131.1163S","K",12.834],[4059512,18.67467083333333,-13.421286111111112,"2MFGC 933","2006AJ....131.1163S","J",14.182],[5171887,18.200666666666667,-13.45272222222222,"6dFGS gJ011248.2-132710","2009MNRAS.399..683J","R",15.01],[5171887,18.200666666666667,-13.45272222222222,"6dFGS gJ011248.2-132710","2009MNRAS.399..683J","B",16.01],[1316489,18.222854166666668,-12.79328888888889,"6dFGS gJ011253.5-124736","2006AJ....131.1163S","J",13.605],[1316489,18.222854166666668,-12.79328888888889,"6dFGS gJ011253.5-124736","2006AJ....131.1163S","R",15.41],[1316489,18.222854166666668,-12.79328888888889,"6dFGS gJ011253.5-124736","2006AJ....131.1163S","H",12.869],[1316489,18.222854166666668,-12.79328888888889,"6dFGS gJ011253.5-124736","2006AJ....131.1163S","K",12.422],[1316489,18.222854166666668,-12.79328888888889,"6dFGS gJ011253.5-124736","2006AJ....131.1163S","B",16.46],[1306377,18.369833333333336,-13.53725277777778,"6dFGS gJ011328.8-133214","2006AJ....131.1163S","K",12.279],[1306377,18.369833333333336,-13.53725277777778,"6dFGS gJ011328.8-133214","2006AJ....131.1163S","B",16.05],[1306377,18.369833333333336,-13.53725277777778,"6dFGS gJ011328.8-133214","2006AJ....131.1163S","R",14.93],[1306377,18.369833333333336,-13.53725277777778,"6dFGS gJ011328.8-133214","2006AJ....131.1163S","J",13.281],[1306377,18.369833333333336,-13.53725277777778,"6dFGS gJ011328.8-133214","2006AJ....131.1163S","H",12.552],[5013337,18.424120833333333,-13.10864722222222,"6dFGS gJ011341.8-130631","2006AJ....131.1163S","R",15.03],[5013337,18.424120833333333,-13.10864722222222,"6dFGS gJ011341.8-130631","2006AJ....131.1163S","J",13.092],[5013337,18.424120833333333,-13.10864722222222,"6dFGS gJ011341.8-130631","2006AJ....131.1163S","H",12.613],[5013337,18.424120833333333,-13.10864722222222,"6dFGS gJ011341.8-130631","2006AJ....131.1163S","K",12.254],[5013337,18.424120833333333,-13.10864722222222,"6dFGS gJ011341.8-130631","2006AJ....131.1163S","B",16.5],[5013356,18.6072,-13.363155555555554,"6dFGS gJ011425.7-132148","2006AJ....131.1163S","K",12.388],[5013356,18.6072,-13.363155555555554,"6dFGS gJ011425.7-132148","2006AJ....131.1163S","H",12.498],[5013356,18.6072,-13.363155555555554,"6dFGS gJ011425.7-132148","2006AJ....131.1163S","J",13.573],[5013356,18.6072,-13.363155555555554,"6dFGS gJ011425.7-132148","2006AJ....131.1163S","R",15.51],[5013356,18.6072,-13.363155555555554,"6dFGS gJ011425.7-132148","2006AJ....131.1163S","B",16.85],[5013360,18.641854166666665,-13.19545,"6dFGS gJ011434.1-131144","2006AJ....131.1163S","B",16.77],[5013360,18.641854166666665,-13.19545,"6dFGS gJ011434.1-131144","2006AJ....131.1163S","H",12.716],[5013360,18.641854166666665,-13.19545,"6dFGS gJ011434.1-131144","2006AJ....131.1163S","J",13.308],[5013360,18.641854166666665,-13.19545,"6dFGS gJ011434.1-131144","2006AJ....131.1163S","R",15.25],[5013360,18.641854166666665,-13.19545,"6dFGS gJ011434.1-131144","2006AJ....131.1163S","K",12.54],[4059515,18.754720833333337,-13.457611111111111,"6dFGS gJ011501.1-132727","2006AJ....131.1163S","B",16.55],[4059515,18.754720833333337,-13.457611111111111,"6dFGS gJ011501.1-132727","2006AJ....131.1163S","J",13.007],[4059515,18.754720833333337,-13.457611111111111,"6dFGS gJ011501.1-132727","2006AJ....131.1163S","H",12.214],[4059515,18.754720833333337,-13.457611111111111,"6dFGS gJ011501.1-132727","2006AJ....131.1163S","K",11.895],[4059515,18.754720833333337,-13.457611111111111,"6dFGS gJ011501.1-132727","2006AJ....131.1163S","R",15.21],[1316346,18.096629583333335,-13.199685833333334,"BD-13   218","1998A&A...335L..65H","B",11.22],[1316346,18.096629583333335,-13.199685833333334,"BD-13   218","1998A&A...335L..65H","V",9.92],[1316346,18.096629583333335,-13.199685833333334,"BD-13   218","1998A&A...335L..65H","J",7.749],[1316346,18.096629583333335,-13.199685833333334,"BD-13   218","1998A&A...335L..65H","H",7.111],[1316346,18.096629583333335,-13.199685833333334,"BD-13   218","1998A&A...335L..65H","K",6.905],[1316456,18.34072041666667,-12.980685277777779,"BD-13   220","1998A&A...335L..65H","B",11.12],[1316456,18.34072041666667,-12.980685277777779,"BD-13   220","1998A&A...335L..65H","V",10.41],[1316456,18.34072041666667,-12.980685277777779,"BD-13   220","1998A&A...335L..65H","J",9.438],[1316456,18.34072041666667,-12.980685277777779,"BD-13   220","1998A&A...335L..65H","H",9.142],[1316456,18.34072041666667,-12.980685277777779,"BD-13   220","1998A&A...335L..65H","K",9.097],[1306359,18.1757625,-13.477777777777778,"BD-14   229","1988A&AS...74..449R","B",12.35],[1306359,18.1757625,-13.477777777777778,"BD-14   229","1988A&AS...74..449R","J",9.789],[1306359,18.1757625,-13.477777777777778,"BD-14   229","1988A&AS...74..449R","K",9.304],[1306359,18.1757625,-13.477777777777778,"BD-14   229","1988A&AS...74..449R","H",9.412],[1306359,18.1757625,-13.477777777777778,"BD-14   229","1988A&AS...74..449R","V",11.7],[1306360,18.194233333333333,-13.473069444444445,"BD-14   230","1988A&AS...74..449R","V",9.8],[1306360,18.194233333333333,-13.473069444444445,"BD-14   230","1988A&AS...74..449R","K",9.727],[1306360,18.194233333333333,-13.473069444444445,"BD-14   230","1988A&AS...74..449R","H",9.77],[1306360,18.194233333333333,-13.473069444444445,"BD-14   230","1988A&AS...74..449R","J",10.098],[1306275,18.407970833333337,-13.664005555555557,"BD-14   234","1988A&AS...74..449R","B",11.67],[1306275,18.407970833333337,-13.664005555555557,"BD-14   234","1988A&AS...74..449R","I",10.9],[1306275,18.407970833333337,-13.664005555555557,"BD-14   234","1988A&AS...74..449R","R",11.29],[1306275,18.407970833333337,-13.664005555555557,"BD-14   234","1988A&AS...74..449R","V",11.06],[1306275,18.407970833333337,-13.664005555555557,"BD-14   234","1988A&AS...74..449R","K",10.408],[1306275,18.407970833333337,-13.664005555555557,"BD-14   234","1988A&AS...74..449R","H",10.475],[1306275,18.407970833333337,-13.664005555555557,"BD-14   234","1988A&AS...74..449R","J",10.644],[1306317,18.443733333333334,-13.513602777777779,"C*   61","2003yCat.1289....0Z","K",10.039],[1306317,18.443733333333334,-13.513602777777779,"C*   61","2003yCat.1289....0Z","B",14],[1306317,18.443733333333334,-13.513602777777779,"C*   61","2003yCat.1289....0Z","V",12.5],[1306317,18.443733333333334,-13.513602777777779,"C*   61","2003yCat.1289....0Z","J",10.684],[1306317,18.443733333333334,-13.513602777777779,"C*   61","2003yCat.1289....0Z","H",10.155],[1306317,18.443733333333334,-13.513602777777779,"C*   61","2003yCat.1289....0Z","R",11.857],[1306317,18.443733333333334,-13.513602777777779,"C*   61","2003yCat.1289....0Z","I",11.361],[1306194,18.116666666666667,-13.485,"G 270-171",null,"B",16],[5224469,18.832179166666666,-13.057361111111112,"GALEX 2674410323492996724","2007ApJ...664...53A","R",18.6],[5224469,18.832179166666666,-13.057361111111112,"GALEX 2674410323492996724","2007ApJ...664...53A","B",18.5],[1306254,18.291666666666668,-13.66,"GD  797","1984A&AS...58..565B","B",16],[1306190,18.504962227887603,-13.475251375255517,"HD   7398","2007A&A...474..653V","B",7.17],[1306190,18.504962227887603,-13.475251375255517,"HD   7398","2007A&A...474..653V","V",6.86],[1306190,18.504962227887603,-13.475251375255517,"HD   7398","2007A&A...474..653V","K",6.08],[1306190,18.504962227887603,-13.475251375255517,"HD   7398","2007A&A...474..653V","H",6.09],[1306190,18.504962227887603,-13.475251375255517,"HD   7398","2007A&A...474..653V","J",6.225],[1306666,18.310791666666667,-13.704416666666665,"LP  707-119","2003yCat.2246....0C","J",15.18],[1306666,18.310791666666667,-13.704416666666665,"LP  707-119","2003yCat.2246....0C","H",14.76],[1306666,18.310791666666667,-13.704416666666665,"LP  707-119","2003yCat.2246....0C","V",17.67],[1306666,18.310791666666667,-13.704416666666665,"LP  707-119","2003yCat.2246....0C","K",14.506],[1316576,18.110666666666663,-13.138583333333333,"LP  707-28","2003yCat.2246....0C","K",11.31],[1316576,18.110666666666663,-13.138583333333333,"LP  707-28","2003yCat.2246....0C","V",16.07],[1316576,18.110666666666663,-13.138583333333333,"LP  707-28","2003yCat.2246....0C","J",12.116],[1316576,18.110666666666663,-13.138583333333333,"LP  707-28","2003yCat.2246....0C","H",11.555],[1316577,18.110124999999996,-13.14263888888889,"LP  707-29","2003yCat.2246....0C","K",10.555],[1316577,18.110124999999996,-13.14263888888889,"LP  707-29","2003yCat.2246....0C","V",15.1],[1316577,18.110124999999996,-13.14263888888889,"LP  707-29","2003yCat.2246....0C","H",10.76],[1316577,18.110124999999996,-13.14263888888889,"LP  707-29","2003yCat.2246....0C","J",11.363],[1306665,18.111791666666665,-13.475944444444446,"LP  707-30","2003yCat.2246....0C","J",10.58],[1306665,18.111791666666665,-13.475944444444446,"LP  707-30","2003yCat.2246....0C","V",14.27],[1306665,18.111791666666665,-13.475944444444446,"LP  707-30","2003yCat.2246....0C","H",9.986],[1306665,18.111791666666665,-13.475944444444446,"LP  707-30","2003yCat.2246....0C","K",9.748],[1316580,18.6875,-13.343,"LP  707-40","2003yCat.2246....0C","K",14.536],[1316580,18.6875,-13.343,"LP  707-40","2003yCat.2246....0C","V",17.84],[1316580,18.6875,-13.343,"LP  707-40","2003yCat.2246....0C","J",15.155],[1316580,18.6875,-13.343,"LP  707-40","2003yCat.2246....0C","H",14.71],[1316416,18.51927916666667,-13.047336111111111,"MCG-02-04-014","2006AJ....131.1163S","J",13.841],[1316416,18.51927916666667,-13.047336111111111,"MCG-02-04-014","2006AJ....131.1163S","H",13.456],[1316416,18.51927916666667,-13.047336111111111,"MCG-02-04-014","2006AJ....131.1163S","B",15],[1316416,18.51927916666667,-13.047336111111111,"MCG-02-04-014","2006AJ....131.1163S","K",12.52],[1306255,18.566666666666666,-13.546666666666667,"PB  8624","1984A&AS...58..565B","B",18.5],[1316430,18.59166666666667,-13.041666666666666,"PB  8626","1984A&AS...58..565B","B",17.5],[7116663,18.511462500000004,-13.548383333333332,"TYC 5275-1225-1","2000A&A...355L..27H","B",12.83],[7116663,18.511462500000004,-13.548383333333332,"TYC 5275-1225-1","2000A&A...355L..27H","V",12.7],[7116670,17.923112500000002,-13.196774999999999,"TYC 5275-1324-1","2000A&A...355L..27H","B",12.74],[7116670,17.923112500000002,-13.196774999999999,"TYC 5275-1324-1","2000A&A...355L..27H","V",12.93],[7116672,18.51792083333333,-13.03548611111111,"TYC 5275-1345-1","2000A&A...355L..27H","V",12.17],[7116672,18.51792083333333,-13.03548611111111,"TYC 5275-1345-1","2000A&A...355L..27H","B",12.51],[1316512,18.563936666666667,-13.241622222222222,"TYC 5275-1346-1","1998A&A...335L..65H","H",9.953],[1316512,18.563936666666667,-13.241622222222222,"TYC 5275-1346-1","1998A&A...335L..65H","V",11.93],[1316512,18.563936666666667,-13.241622222222222,"TYC 5275-1346-1","1998A&A...335L..65H","B",12.28],[1316512,18.563936666666667,-13.241622222222222,"TYC 5275-1346-1","1998A&A...335L..65H","K",9.92],[1316512,18.563936666666667,-13.241622222222222,"TYC 5275-1346-1","1998A&A...335L..65H","J",10.319],[7116674,18.0438625,-13.272958333333332,"TYC 5275-1388-1","2000A&A...355L..27H","B",11.93],[7116674,18.0438625,-13.272958333333332,"TYC 5275-1388-1","2000A&A...355L..27H","V",11.8],[7116677,18.055041666666664,-13.47173888888889,"TYC 5275-1469-1","2000A&A...355L..27H","B",12.42],[7116677,18.055041666666664,-13.47173888888889,"TYC 5275-1469-1","2000A&A...355L..27H","V",12.15],[7116683,18.436408333333333,-13.73427222222222,"TYC 5275-1677-1","2000A&A...355L..27H","V",12.26],[7116683,18.436408333333333,-13.73427222222222,"TYC 5275-1677-1","2000A&A...355L..27H","B",12.96],[7116702,18.80410833333334,-13.29923888888889,"TYC 5275-1889-1","2000A&A...355L..27H","B",11.79],[7116702,18.80410833333334,-13.29923888888889,"TYC 5275-1889-1","2000A&A...355L..27H","V",10.94],[7116723,18.80049166666667,-13.299452777777777,"TYC 5275-2329-1","2000A&A...355L..27H","B",11.99],[7116723,18.80049166666667,-13.299452777777777,"TYC 5275-2329-1","2000A&A...355L..27H","V",11.13],[1316551,17.986907916666667,-13.283665833333332,"VCS5 J0111-1317","2007AJ....133.1236K","R",21.32],[1306633,18.292458333333332,-13.657305555555554,"WD 0110-139","2000AJ....119..241L","V",15.68]],"metadata":[{"ucd":"meta.record;meta.id","description":"Object internal identifier","name":"oid","arraysize":1,"datatype":"long"},{"unit":"deg","ucd":"pos.eq.ra;meta.main","description":"Right ascension","name":"ra","arraysize":1,"datatype":"double"},{"unit":"deg","ucd":"pos.eq.dec;meta.main","description":"Declination","name":"dec","arraysize":1,"datatype":"double"},{"ucd":"meta.id;meta.main","description":"Main identifier for an object","name":"main_id","arraysize":"*","datatype":"char"},{"ucd":"meta.bib.bibcode;pos.eq","description":"Coordinate reference","name":"coo_bibcode","arraysize":"*","datatype":"char"},{"ucd":"instr.filter","description":"flux filter name","name":"filter","arraysize":"*","datatype":"char"},{"name":"flux","arraysize":1,"datatype":"float"}]}
    
    fluxes = {}
    for object in data['data']
      id      = object[3]
      ra      = object[2]
      dec     = object[3]
      bib     = object[4]
      filter  = object[5]
      mag     = object[6]
      fluxes[id] = {} unless fluxes.hasOwnProperty id
      fluxes[id]['ra']    = ra
      fluxes[id]['dec']   = dec
      fluxes[id]['bib']   = bib
      fluxes[id][filter]  = mag

    # $.ajax({
    #   dataType: 'jsonp',
    #   url: source,
    #   callback: 'givemeansedbaby',
    #   success: (data) ->
    #     $.each(data, ->
    #       $.each(this, (k, v) ->
    #         id      = v[3]
    #         filter  = v[5]
    #         value   = v[6]
    #         if not fluxes[id]
    #           fluxes[id] = {}
    #         fluxes[id][filter] = value
    #       )
    #     )
    #     console.log fluxes
    # })
    

  setupModels: (data) ->
    # Code to set up models for Chromoscope, Biblio and SpectralEnergyDistribution
    

  setupPlot: (data) ->
    console.log 'setupPlot', data, @plots
    # @plots.html("<div id='something' style='width:600px;height:300px'></div>")
    # $.plot($("#something"), [[1,1], [2,2], [3,3])

module.exports = Sed